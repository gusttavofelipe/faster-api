name: Update Dependencies

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Add uv to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Capture old lockfile
        run: cp uv.lock /tmp/uv.lock.old

      - name: Update dependencies
        run: |
          uv lock --upgrade
          uv sync --upgrade

      - name: Generate summary
        run: |
          cat > parse_deps.py << 'PYTHON_SCRIPT'
          import re
          
          # Read both lockfiles
          with open('/tmp/uv.lock.old', 'r') as f:
              old_content = f.read()
          
          with open('uv.lock', 'r') as f:
              new_content = f.read()
          
          # Extract package versions using regex
          package_pattern = r'\[\[package\]\]\s+name = "([^"]+)"[^\[]*?version = "([^"]+)"'
          
          old_packages = {name: version for name, version in re.findall(package_pattern, old_content)}
          new_packages = {name: version for name, version in re.findall(package_pattern, new_content)}
          
          # Categorize changes
          updated = []
          added = []
          removed = []
          
          for name, new_ver in sorted(new_packages.items()):
              if name in old_packages:
                  old_ver = old_packages[name]
                  if old_ver != new_ver:
                      updated.append(f"- {name}: {old_ver} â†’ {new_ver}")
              else:
                  added.append(f"- {name}: {new_ver}")
          
          for name, old_ver in sorted(old_packages.items()):
              if name not in new_packages:
                  removed.append(f"- {name}: {old_ver}")
          
          # Generate summary
          summary = "### Updated\n"
          summary += "\n".join(updated) if updated else "(none)"
          summary += "\n\n### Added\n"
          summary += "\n".join(added) if added else "(none)"
          summary += "\n\n### Removed\n"
          summary += "\n".join(removed) if removed else "(none)"
          
          # Write to file
          with open('dependency-summary.txt', 'w') as f:
              f.write(summary)
          PYTHON_SCRIPT
          
          python3 parse_deps.py

      - name: Read summary for PR body
        id: summary
        run: |
          SUMMARY=$(cat dependency-summary.txt)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Clean up temporary files
        run: |
          rm -f parse_deps.py dependency-summary.txt

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update dependencies"
          branch: deps-update-${{ github.run_id }}
          title: "Update dependencies"
          body: ${{ steps.summary.outputs.content }}
